From 31f5f47e3a6461660a829f2664745eb5a6600e6a Mon Sep 17 00:00:00 2001
From: maxwen <max.weninger@gmail.com>
Date: Fri, 8 Sep 2017 00:01:25 +0200
Subject: [PATCH] wificond: add backward comp for kernels without
 NL80211_ATTR_MAC

Change-Id: I572e9942648429bab3a72bf3278d404069837dbf
---
 Android.mk            |  3 +++
 net/netlink_utils.cpp | 14 +++++++++++++-
 2 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/Android.mk b/Android.mk
index 3579197..c0e08e4 100644
--- a/Android.mk
+++ b/Android.mk
@@ -18,6 +18,9 @@ wificond_parent_dir := $(LOCAL_PATH)/../
 wificond_includes := \
     $(wificond_parent_dir)
 
+ifeq ($(TARGET_KERNEL_NO_NL80211_ATTR_MAC),true)
+wificond_cpp_flags += -DCONFIG_NO_NL80211_ATTR_MAC
+endif
 
 ###
 ### wificond daemon.
diff --git a/net/netlink_utils.cpp b/net/netlink_utils.cpp
index 0fa0116..646b60d 100644
--- a/net/netlink_utils.cpp
+++ b/net/netlink_utils.cpp
@@ -148,12 +148,24 @@ bool NetlinkUtils::GetInterfaces(uint32_t wiphy_index,
       LOG(WARNING) << "Failed to get interface name";
       continue;
     }
-
     vector<uint8_t> if_mac_addr;
+
+#ifdef CONFIG_NO_NL80211_ATTR_MAC
+    LOG(WARNING) << "Using default mac address";
+    // TODO could read from property
+    // see nl80211_send_iface
+    if_mac_addr.push_back(0x02);
+    if_mac_addr.push_back(0x00);
+    if_mac_addr.push_back(0x00);
+    if_mac_addr.push_back(0x00);
+    if_mac_addr.push_back(0x00);
+    if_mac_addr.push_back(0x00);
+#else
     if (!packet->GetAttributeValue(NL80211_ATTR_MAC, &if_mac_addr)) {
       LOG(WARNING) << "Failed to get interface mac address";
       continue;
     }
+#endif
 
     interface_info->emplace_back(if_index, if_name, if_mac_addr);
   }
-- 
2.9.5


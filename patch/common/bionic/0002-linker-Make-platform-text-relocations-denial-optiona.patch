From 53fccdf536fec69416d24202360e17e322495ce0 Mon Sep 17 00:00:00 2001
From: sub77 <sub77@ymail.com>
Date: Mon, 29 Oct 2018 22:16:13 +0000
Subject: [PATCH 2/2] linker: Make platform text relocations denial optional

 * Use the TARGET_NEEDS_PLATFORM_TEXT_RELOCATIONS := true
    configuration to allow a device to use legacy proprietary
    libraries like camera on non-user build variants

 * Partial revert "Remove textrels support for platform libs"
    commit 8068786ae67835291521e52f39c695e40f3ad20d.

 * Forward-port to AOSP 8.0, use __ANDROID_API_M__
    and adapt to Android.bp build rules

Change-Id: I994ab1a600a0b237b496ceebe2dd54febc28a6bd
Signed-off-by: Adrian DC <radian.dc@gmail.com>
Signed-off-by: sub77 <sub77@ymail.com>
---
 linker/Android.bp | 5 ++++-
 linker/linker.cpp | 5 +++++
 2 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/linker/Android.bp b/linker/Android.bp
index e122d8fd8..d8cc985d2 100644
--- a/linker/Android.bp
+++ b/linker/Android.bp
@@ -168,7 +168,10 @@ cc_binary {
         },
     },
 
-    cppflags: ["-Wold-style-cast"],
+    cppflags: [
+        "-Wold-style-cast",
+        "-DTARGET_NEEDS_PLATFORM_TEXT_RELOCATIONS",
+        ],
 
     // we are going to link libc++_static manually because
     // when stl is not set to "none" build system adds libdl
diff --git a/linker/linker.cpp b/linker/linker.cpp
index 06528840b..932f95d7a 100644
--- a/linker/linker.cpp
+++ b/linker/linker.cpp
@@ -3623,8 +3623,13 @@ bool soinfo::link_image(const soinfo_list_t& global_group, const soinfo_list_t&
 #if !defined(__LP64__)
   if (has_text_relocations) {
     // Fail if app is targeting M or above.
+#if defined(TARGET_NEEDS_PLATFORM_TEXT_RELOCATIONS)
+    if (get_application_target_sdk_version() != __ANDROID_API__
+        && get_application_target_sdk_version() >= __ANDROID_API_M__) {
+#else
     int app_target_api_level = get_application_target_sdk_version();
     if (app_target_api_level >= __ANDROID_API_M__) {
+#endif
       DL_ERR_AND_LOG("\"%s\" has text relocations (https://android.googlesource.com/platform/"
                      "bionic/+/master/android-changes-for-ndk-developers.md#Text-Relocations-"
                      "Enforced-for-API-level-23)", get_realpath());
-- 
2.17.2

